{
  "Универсальный conanfile.py": {
    "prefix": "ivs_univ_conanfile",
    "body": [
      "# -*- coding: utf-8 -*-",
      "# pylint: skip-file",
      "from __future__ import print_function",
      "import ivpackage, sys, subprocess, os",
      "",
      "# !!! Все, что ниже, не менять !!!",
      "def get_ivutils(module, paths, pip_url=None, fatal=True, env_name=None):",
      "    scriptdir, _ = os.path.split(os.path.realpath(__file__))",
      "    ivaddingpath = os.path.dirname(scriptdir) ",
      "    ivaddingpath = os.path.join(ivaddingpath, *paths)",
      "",
      "    if os.path.isdir(ivaddingpath) is False and env_name is not None:",
      "        sys.stderr.write('Cannot find %s, use env\\n' % (ivaddingpath))",
      "        ivaddingpath = os.environ.get(env_name, '')    ",
      "    if os.path.isdir(ivaddingpath) is False and pip_url is not None:",
      "        sys.stderr.write('Cannot find %s, use pip\\n' % (ivaddingpath))",
      "        pip_args = [",
      "            os.path.abspath(sys.executable), '-m', 'pip', 'install', '-U',",
      "            '--trusted-host=git.iv.integra-s.com',",
      "            '--target=%s' % scriptdir, pip_url",
      "        ]",
      "        with open(os.devnull, 'w') as devnull:",
      "            subprocess.check_output(pip_args, stderr=devnull)",
      "        ivaddingpath = os.path.join(scriptdir, 'iv', 'conanfile')",
      "    sys.path.append(ivaddingpath)",
      "    ivmod = None ",
      "    try:",
      "        ivmods = list(map(__import__, [module]))",
      "        ivmod = ivmods[0]",
      "    except ImportError as exc:",
      "        if fatal is True:",
      "            raise Exception('ImportError, cannot find %s.%s\\n' % (paths, module))",
      "        else:",
      "            sys.stderr.write('ImportError, %s.%s\\n' % (paths, module))",
      "    sys.path.remove(ivaddingpath)",
      "    return ivmod",
      "",
      "ivutils = get_ivutils(",
      "    'utils', ['python.ivutils', 'iv', 'conanfile'],",
      "    'https://git.iv.integra-s.com/IntegraVideo/python.ivutils/archive/master.zip',",
      "    True, 'IV_PYTHON_UTILS_DIR'",
      ")",
      "ivconantools = get_ivutils(",
      "    'ivconantools', ['ivconantools'], pip_url=None, fatal=False)",
      "",
      "from conans import ConanFile",
      "",
      "package_git_url = ivutils.git_repo_url()",
      "git_branch = ivutils.git_repo_branch()",
      "",
      "",
      "class ProjectConan(ConanFile):",
      "    scriptdir, _ = os.path.split(os.path.realpath(__file__))",
      "    name = package_git_url.split('/')[-1][:-4]",
      "    exports = 'repo_url.txt', 'repo_branch.txt', 'ivpackage.py'",
      "    version = ivpackage.iv_package_version",
      "    settings = 'os', 'build_type', 'arch'  #, 'compiler'",
      "    description = ivpackage.iv_package_desc",
      "    url = 'None'",
      "    license = 'None'",
      "    short_paths = True",
      "    generators = ivutils.choose_generator(ivpackage)",
      "    scm = {",
      "      'type': 'git',",
      "      'url': 'auto',",
      "      'revision': 'auto',",
      "      'verify_ssl': False",
      "    }",
      "",
      "    def configure(self):",
      "        ivutils.conanfile_configure(self, ivpackage)",
      "",
      "    def build_requirements(self):",
      "        ivutils.conanfile_build_requirements(self, ivpackage, ivconantools, git_branch)",
      "",
      "    def requirements(self):",
      "        ivutils.conanfile_requirements(self, ivpackage, git_branch)",
      "",
      "    def build(self):",
      "        ivutils.conanfile_build(self, ivpackage, ivconantools)",
      "",
      "    def imports(self):",
      "        ivutils.conanfile_imports(self, ivpackage, git_branch)",
      "",
      "    def package(self):",
      "        ivutils.conanfile_package(self, ivpackage, ivconantools)",
      "",
      "    def package_id(self):",
      "        ivutils.conanfile_package_id(self)",
      "",
      "    def deploy(self):",
      "        ivutils.conanfile_deploy(self, ivpackage)",
      "",
      "",
      "if __name__ == '__main__':",
      "    scriptdir, _ = os.path.split(os.path.realpath(__file__))",
      "    ivutils.conanfile_main(scriptdir, ivpackage, package_git_url)"
    ],
    "description": "Универсальный conanfile.py"
  },
  "Секция iv_tests из ivpackage.py": {
    "prefix": "ivs_ivpackage_iv_tests",
    "body": [
      "iv_tests = {",
      "  'iv_depends': {",
      "    'log_dll': {'depends': True, 'user': 'av', 'version':'[>1.0.1]', 'imports': [",
      "        {'pattern': '*.dll', 'src': '.', 'dst': 'build/bin'},",
      "        {'pattern': '*.so', 'src': '.', 'dst': 'build/bin'}",
      "      ]",
      "    },",
      "  },",
      "  'artifactory_binaries': ${1:True}",
      "}"
    ],
    "description": "Секция iv_tests из ivpackage.py"
  },
  "conanfile.py для test_package": {
    "prefix": "ivs_test_package_conanfile",
    "body": [
      "# -*- coding: utf-8 -*-",
      "# pylint: skip-file",
      "from __future__ import print_function",
      "",
      "# !!! Все, что ниже, не менять !!!",
      "",
      "",
      "def safe_get_module_attr(module, attr):",
      "    from conans import errors",
      "    if module is None:",
      "        return None",
      "    try:",
      "        if attr in module:",
      "            return module[attr]",
      "    except TypeError:",
      "        pass",
      "    try:",
      "        return getattr(module, attr)",
      "    except AttributeError:",
      "        return None",
      "    except errors.ConanException:",
      "        return None",
      "",
      "",
      "iv_tests = None",
      "iv_depends = None",
      "artifactory_binaries = None",
      "dont_del_dist_and_version = None",
      "cmd_line_args = ''",
      "iv_build_system = None",
      "",
      "",
      "def load_ivpackage_data():",
      "    import os",
      "    import sys",
      "    scriptdir, _ = os.path.split(os.path.realpath(__file__))",
      "    repopath = os.path.dirname(scriptdir)",
      "    if os.path.isfile(os.path.join(repopath, 'ivpackage.py')) is True:",
      "        sys.path.append(repopath)",
      "        modules = list(map(__import__, ['ivpackage']))",
      "        sys.path.remove(repopath)",
      "        ivpackage = modules[0]",
      "        global iv_tests",
      "        iv_tests = safe_get_module_attr(ivpackage, 'iv_tests')",
      "        global iv_depends",
      "        iv_depends = safe_get_module_attr(iv_tests, 'iv_depends')",
      "        global cmd_line_args",
      "        cmd_line_args = safe_get_module_attr(iv_tests, 'cmd_line_args')",
      "        if cmd_line_args is None:",
      "            cmd_line_args = ''",
      "        global artifactory_binaries",
      "        artifactory_binaries = safe_get_module_attr(",
      "            iv_tests, 'artifactory_binaries')",
      "        global dont_del_dist_and_version",
      "        dont_del_dist_and_version = safe_get_module_attr(",
      "            iv_tests, 'dont_del_dist_and_version')",
      "        global iv_build_system",
      "        iv_build_system = safe_get_module_attr(ivpackage, 'iv_build_system')",
      "        del sys.modules['ivpackage']",
      "        del ivpackage",
      "",
      "",
      "load_ivpackage_data()",
      "",
      "from conans import ConanFile, CMake, tools, RunEnvironment",
      "import os",
      "",
      "",
      "def git_repo_url():",
      "    repo_url = ''",
      "    curworkpath = os.getcwd()",
      "    if os.path.exists(os.path.join(curworkpath, '.git')) or os.path.exists(os.path.join(os.path.dirname(curworkpath), '.git')):",
      "        from conans.client.runner import ConanRunner",
      "        try:",
      "            from StringIO import StringIO",
      "        except ImportError:",
      "            from io import StringIO",
      "        output = StringIO()",
      "        ConanRunner()('git config --get remote.origin.url', output)",
      "        repo_url = output.getvalue().strip()",
      "        tools.save('repo_url.txt', '%s' % repo_url)",
      "    elif os.path.exists('repo_url.txt'):",
      "        repo_url = tools.load('repo_url.txt')",
      "    return repo_url",
      "",
      "",
      "def is_target_enabled(conanfile, depend):",
      "    distr = safe_get_module_attr(conanfile.settings.os, 'dist')",
      "    if distr is not None:",
      "        version = safe_get_module_attr(conanfile.settings.os, 'version')",
      "        if version is None:",
      "            distr = None",
      "        else:",
      "            distr = distr + str(version)",
      "    if distr is None:",
      "        distr = str(conanfile.settings.os)",
      "    targets = safe_get_module_attr(depend, 'targets')",
      "    if targets is not None:",
      "        if distr not in targets:",
      "            return False",
      "        arch = str(conanfile.settings.arch)",
      "        if arch not in targets[distr]:",
      "            return False",
      "        build_type = str(conanfile.settings.build_type)",
      "        if build_type not in targets[distr][arch]:",
      "            return False",
      "    return True",
      "",
      "",
      "def set_depend_imports(conanfile, package):",
      "    if iv_depends is None:",
      "        return",
      "    if package not in iv_depends:",
      "        return",
      "    if 'depends' not in iv_depends[package]:",
      "        return",
      "    if iv_depends[package]['depends'] is False:",
      "        return",
      "    if is_target_enabled(conanfile, iv_depends[package]) is False:",
      "        return",
      "    if 'imports' not in iv_depends[package]:",
      "        return",
      "    for imp in iv_depends[package]['imports']:",
      "        if 'pattern' not in imp:",
      "            continue",
      "        if 'dst' not in imp:",
      "            continue",
      "        if 'src' not in imp:",
      "            continue",
      "        conanfile.copy(imp['pattern'], dst=conanfile.scriptdir +",
      "                       '/' + imp['dst'], src=imp['src'], root_package=package)",
      "",
      "",
      "def get_depend_string(conanfile, package, header_only=False):",
      "    depend_string = None",
      "    channel = 'stable'",
      "    if conanfile.packagename == package:",
      "        channel = os.environ.get('IV_CONAN_PACKAGE_CHANNEL', 'stable')",
      "    if iv_depends is None:",
      "        return None",
      "    if package not in iv_depends:",
      "        return None",
      "    if 'depends' not in iv_depends[package]:",
      "        return None",
      "    if iv_depends[package]['depends'] is False:",
      "        return None",
      "    if is_target_enabled(conanfile, iv_depends[package]) is False:",
      "        return None",
      "    if header_only is not None:",
      "        if header_only is True:",
      "            if 'header_only' not in iv_depends[package] or iv_depends[package]['header_only'] is False:",
      "                return None",
      "        elif 'header_only' in iv_depends[package] and iv_depends[package]['header_only'] is True:",
      "            return None",
      "    depend_string = '%s/%s@%s/%s' % (package, iv_depends[package].get(",
      "        'version', '[~0]'), iv_depends[package]['user'], iv_depends[package].get('channel', channel))",
      "    return depend_string",
      "",
      "",
      "package_git_url = git_repo_url()",
      "",
      "",
      "class DefaultNameConan(ConanFile):",
      "    scriptdir, _ = os.path.split(os.path.realpath(__file__))",
      "    packagename = os.environ.get('IV_CONAN_PACKAGE_NAME', package_git_url.split(",
      "        '/')[-1][:-4]) if package_git_url != '' else os.environ.get('IV_CONAN_PACKAGE_NAME', '')",
      "    name = 'test_package'",
      "    settings = 'os', 'arch', 'build_type'",
      "    if 'Qt' in iv_build_system and iv_build_system['Qt'] is True:",
      "        generators = 'qmake'",
      "    else:",
      "        generators = 'txt'",
      "",
      "    def configure(self):",
      "        if dont_del_dist_and_version is not None and dont_del_dist_and_version is True:",
      "            return",
      "        if self.settings.os == 'Linux':",
      "            del self.settings.os.version",
      "            del self.settings.os.dist",
      "",
      "    def build_requirements(self):",
      "        if 'Qt' in iv_build_system and iv_build_system['Qt'] is True:",
      "            self.build_requires('IVConanTools/[~0]@iv/stable')",
      "        if iv_depends is None:",
      "            return",
      "        for key in iv_depends:",
      "            depend = get_depend_string(self, key, header_only=True)",
      "            if depend is None:",
      "                continue",
      "            self.build_requires(depend)",
      "",
      "    def requirements(self):",
      "        if iv_depends is None:",
      "            return",
      "        for key in iv_depends:",
      "            depend = get_depend_string(self, key)",
      "            if depend is None:",
      "                continue",
      "            self.requires(depend, private=False, override=False)",
      "",
      "    def build(self):",
      "        if 'Qt' in iv_build_system and iv_build_system['Qt'] is True:",
      "            with tools.environment_append({'IV_QT_VERSION': '5.11.1'}):",
      "                with tools.pythonpath(self):",
      "                    import ivconantools",
      "                    ivconantools.qt_build(self, True)",
      "        else:",
      "            cmake = CMake(self, generator='Visual Studio 15 Win64' if self.settings.os ==",
      "                          'Windows' else 'Unix Makefiles')",
      "            cmake.configure()",
      "            cmake.build()",
      "",
      "    def imports(self):",
      "        self.copy('*', dst='include', src='include')",
      "        self.copy('*', dst='bin/lib', src='lib')",
      "        self.copy('*', dst='libs', src='libs')",
      "        self.copy('*', dst='bin/plugins', src='plugins')",
      "        self.copy('*', dst='bin/qtplugins', src='qtplugins')",
      "        self.copy('*', dst='bin', src='bin')",
      "",
      "        if iv_depends is None:",
      "            return",
      "        for key in iv_depends:",
      "            set_depend_imports(self, key)",
      "",
      "    def test(self):",
      "        dst_folder = os.path.join(self.build_folder, 'bin')",
      "        if artifactory_binaries is not None and artifactory_binaries is True:",
      "            owner = os.environ.get('IV_CONAN_PACKAGE_USER', package_git_url.split(",
      "                '/')[-2].split(':')[-1]) if package_git_url != '' else os.environ.get('IV_CONAN_PACKAGE_USER', '')",
      "            print('owner %s' % owner)",
      "            zip_file = self.packagename + '.zip'",
      "            tools.download('https://artifactory.iv.integra-s.com/artifactory/binaries/tests_data/'",
      "                           + owner + '/' + zip_file, zip_file, False)",
      "            tools.unzip(zip_file, dst_folder)",
      "        does_not_run = os.environ.get('IVTEST_DOES_NOT_RUN', None)",
      "        if does_not_run is None:",
      "            with tools.environment_append({'QT_QPA_PLATFORM':'minimal', 'INTEGRA_S_VIDEO_LOG_WRITE_HOME_ALLOW': '1', 'PATH': os.path.join(dst_folder, 'lib'), 'LD_LIBRARY_PATH': os.path.join(dst_folder, 'lib')}):",
      "                bin_path = os.path.join(dst_folder, self.name)",
      "                self.run(bin_path + ' ' + cmd_line_args)",
      "",
      "",
      "if __name__ == '__main__':",
      "    import optparse",
      "    parser = optparse.OptionParser()",
      "    parser.add_option('-c', '--cmd', action='store',",
      "                      dest='cmd', default='', help='команда(version)')",
      "    options, args = parser.parse_args()",
      "    if options.cmd == 'version':",
      "        print('0.0.4.0')",
      "        exit(0)",
      "    else:",
      "        exit(1)"
    ],
    "description": "conanfile.py для test_package"
  }
}